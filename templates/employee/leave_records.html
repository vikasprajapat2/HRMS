{% extends 'base.html' %}
{% block content %}
<div class="container mt-4">
  <h4 class="mb-4"><i class="fas fa-history me-2"></i>Leave Records</h4>

  <!-- Statistics Cards -->
  <div class="row mb-4">
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-title text-muted">Total Requests</h6>
          <h3 class="text-primary">{{ stats.total }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-title text-muted">Pending</h6>
          <h3 class="text-warning">{{ stats.pending }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-title text-muted">Approved</h6>
          <h3 class="text-success">{{ stats.approved }}</h3>
        </div>
      </div>
    </div>
    <div class="col-md-3">
      <div class="card text-center">
        <div class="card-body">
          <h6 class="card-title text-muted">Total Days Approved</h6>
          <h3 class="text-info">{{ stats.total_days_approved }}</h3>
        </div>
      </div>
    </div>
  </div>

  <!-- Filter -->
  <div class="card mb-4">
    <div class="card-body">
      <form method="GET" class="row g-2 align-items-end">
        <div class="col-md-4">
          <label class="form-label">Filter by Status</label>
          <select name="status" class="form-select">
            <option value="all" {% if status_filter == 'all' %}selected{% endif %}>All</option>
            <option value="pending" {% if status_filter == 'pending' %}selected{% endif %}>Pending</option>
            <option value="approved" {% if status_filter == 'approved' %}selected{% endif %}>Approved</option>
            <option value="rejected" {% if status_filter == 'rejected' %}selected{% endif %}>Rejected</option>
          </select>
        </div>
        <div class="col-md-2">
          <button type="submit" class="btn btn-primary w-100">Filter</button>
        </div>
        <div class="col-md-2">
          <a href="{{ url_for('employee.leave_records') }}" class="btn btn-secondary w-100">Reset</a>
        </div>
        <div class="col-md-4 text-end">
          <a href="{{ url_for('employee.apply_leave') }}" class="btn btn-success"><i class="fas fa-plus me-2"></i>New Request</a>
        </div>
      </form>
    </div>
  </div>

  <!-- Leave Records Table -->
  {% if leaves %}
  <div class="card">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-bordered table-hover table-sm mb-0">
          <thead class="table-light">
            <tr>
              <th>Leave Type</th>
              <th>Start Date</th>
              <th>End Date</th>
              <th>Days</th>
              <th>Reason</th>
              <th>Status</th>
              <th>Applied On</th>
              <th>Actions</th>
            </tr>
          </thead>
          <tbody>
            {% for leave in leaves %}
            <tr>
              <td>
                <span class="badge bg-light text-dark">{{ leave.leave_type|upper }}</span>
              </td>
              <td>{{ leave.start_date.strftime('%d-%m-%Y') }}</td>
              <td>{{ leave.end_date.strftime('%d-%m-%Y') }}</td>
              <td>
                {% set days = (leave.end_date - leave.start_date).days + 1 %}
                <strong>{{ days }}</strong>
              </td>
              <td>{{ leave.reason or '-' }}</td>
              <td>
                {% if leave.status == 'approved' %}
                  <span class="badge bg-success"><i class="fas fa-check me-1"></i>Approved</span>
                {% elif leave.status == 'rejected' %}
                  <span class="badge bg-danger"><i class="fas fa-times me-1"></i>Rejected</span>
                {% else %}
                  <span class="badge bg-warning text-dark"><i class="fas fa-hourglass-half me-1"></i>Pending</span>
                {% endif %}
              </td>
              <td>{{ leave.created_at.strftime('%d-%m-%Y %H:%M') if leave.created_at else '-' }}</td>
              <td>
                {% if leave.status == 'pending' %}
                <form method="POST" action="{{ url_for('user.cancel_leave', id=leave.id) }}" style="display:inline;">
                  <button type="submit" class="btn btn-sm btn-outline-danger" onclick="return confirm('Cancel this leave request?');" title="Cancel Request">
                    <i class="fas fa-times"></i>
                  </button>
                </form>
                {% else %}
                <span class="text-muted small">-</span>
                {% endif %}
              </td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>
  {% else %}
  <div class="alert alert-info text-center">
    <p><i class="fas fa-info-circle me-2"></i>No leave records found for the selected filter.</p>
    <a href="{{ url_for('employee.apply_leave') }}" class="btn btn-primary btn-sm">Apply for Leave</a>
  </div>
  {% endif %}
</div>
{% endblock %}
